name: Apply ComfyUI Bundle to Dev Instance

on:
  workflow_dispatch:
    inputs:
      instance_id:
        description: 'EC2 instance ID (dev GPU node)'
        required: true
        type: string
      stage:
        description: 'Stage (staging or production)'
        required: false
        type: choice
        default: staging
        options:
          - staging
          - production
      fleet_slug:
        description: 'Fleet slug (e.g. gpu-default)'
        required: true
        type: string
      bundle_prefix:
        description: 'Bundle S3 prefix (e.g. bundles/<bundle_id>)'
        required: true
        type: string
      models_bucket:
        description: 'S3 bucket with asset bundles (bp-models-<account>-<stage>)'
        required: false
        type: string
      logs_bucket:
        description: 'Optional: S3 bucket for logs (bp-logs-<account>-<stage>)'
        required: false
        type: string
      notes:
        description: 'Optional notes for audit log'
        required: false
        type: string
      aws_region:
        description: 'AWS region'
        required: false
        default: 'us-east-1'
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  apply-bundle:
    name: Apply Bundle via SSM
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ inputs.aws_region }}
      STAGE: ${{ inputs.stage }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.stage == 'production' && secrets.AWS_DEPLOY_ROLE_ARN_PRODUCTION || secrets.AWS_DEPLOY_ROLE_ARN_STAGING }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify instance is SSM-managed
        shell: bash
        run: |
          set -euo pipefail
          INSTANCE_ID="${{ inputs.instance_id }}"
          FOUND=$(aws ssm describe-instance-information \
            --filters "Key=InstanceIds,Values=${INSTANCE_ID}" \
            --query "InstanceInformationList[0].InstanceId" \
            --output text)
          if [[ -z "${FOUND}" || "${FOUND}" == "None" ]]; then
            echo "Instance ${INSTANCE_ID} is not SSM-managed. Ensure it has an SSM-enabled instance profile." >&2
            exit 1
          fi

      - name: Resolve models bucket
        shell: bash
        run: |
          set -euo pipefail
          MODELS_BUCKET="${{ inputs.models_bucket }}"
          if [[ -z "${MODELS_BUCKET}" ]]; then
            MODELS_BUCKET=$(aws ssm get-parameter \
              --name "/bp/${STAGE}/models/bucket" \
              --query "Parameter.Value" \
              --output text)
          fi
          if [[ -z "${MODELS_BUCKET}" || "${MODELS_BUCKET}" == "None" ]]; then
            echo "models_bucket is required (input empty and SSM lookup failed)." >&2
            exit 1
          fi
          echo "MODELS_BUCKET=${MODELS_BUCKET}" >> "$GITHUB_ENV"

      - name: Send SSM command
        id: send
        run: |
          BUNDLE_PREFIX="${{ inputs.bundle_prefix }}"
          BUNDLE_PREFIX="${BUNDLE_PREFIX%/}"
          CMD_APPLY="MODELS_BUCKET=${MODELS_BUCKET} BUNDLE_PREFIX=${BUNDLE_PREFIX} /opt/comfyui/bin/apply-bundle.sh"
          export CMD_APPLY
          PARAMS=$(python3 - <<'PY'
          import json
          import os

          cmds = [
              'if ! test -x /opt/comfyui/bin/apply-bundle.sh; then echo "apply-bundle.sh missing (wrong AMI)"; exit 1; fi',
              os.environ["CMD_APPLY"],
              "sudo systemctl restart comfyui.service",
              "sudo systemctl restart comfyui-worker.service || true",
          ]
          print(json.dumps({"commands": cmds}))
          PY
          )
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ inputs.instance_id }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Apply ComfyUI asset bundle" \
            --parameters "${PARAMS}" \
            --query "Command.CommandId" --output text)
          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
          echo "SSM command ID: $COMMAND_ID"

      - name: Wait for command completion
        run: |
          aws ssm wait command-executed \
            --command-id "${{ steps.send.outputs.command_id }}" \
            --instance-id "${{ inputs.instance_id }}"

      - name: Fetch command output
        run: |
          aws ssm get-command-invocation \
            --command-id "${{ steps.send.outputs.command_id }}" \
            --instance-id "${{ inputs.instance_id }}" \
            --output json > command-output.json
          cat command-output.json

      - name: Upload command output (optional)
        if: inputs.logs_bucket != ''
        run: |
          BUNDLE_PREFIX="${{ inputs.bundle_prefix }}"
          BUNDLE_PREFIX="${BUNDLE_PREFIX%/}"
          BUNDLE_ID=$(basename "$BUNDLE_PREFIX")
          LOG_KEY="asset-sync/${{ inputs.fleet_slug }}/${BUNDLE_ID}/$(date -u +%Y%m%dT%H%M%SZ)-${{ inputs.instance_id }}.json"
          aws s3 cp command-output.json "s3://${{ inputs.logs_bucket }}/$LOG_KEY"
          echo "log_key=$LOG_KEY" >> $GITHUB_OUTPUT
        id: upload

      - name: Record audit log (optional)
        env:
          ASSET_OPS_API_URL: ${{ secrets.ASSET_OPS_API_URL }}
          ASSET_OPS_SECRET: ${{ secrets.ASSET_OPS_SECRET }}
        run: |
          if [ -z "${ASSET_OPS_API_URL}" ] || [ -z "${ASSET_OPS_SECRET}" ]; then
            echo "ASSET_OPS_* secrets not set; skipping audit log."
            exit 0
          fi

          LOG_KEY="${{ steps.upload.outputs.log_key }}"
          BUNDLE_PREFIX="${{ inputs.bundle_prefix }}"
          BUNDLE_PREFIX="${BUNDLE_PREFIX%/}"
          BUNDLE_ID=$(basename "$BUNDLE_PREFIX")
          payload=$(jq -n \
            --arg bundle_id "$BUNDLE_ID" \
            --arg event "dev_bundle_applied" \
            --arg notes "${{ inputs.notes }}" \
            --arg artifact_s3_key "$LOG_KEY" \
            --arg fleet_slug "${{ inputs.fleet_slug }}" \
            --arg instance_id "${{ inputs.instance_id }}" \
            --arg bundle_prefix "$BUNDLE_PREFIX" \
            '{bundle_id:$bundle_id,event:$event,notes:$notes,artifact_s3_key:$artifact_s3_key,metadata:{fleet_slug:$fleet_slug,instance_id:$instance_id,bundle_prefix:$bundle_prefix}}')
          curl -sS -X POST "$ASSET_OPS_API_URL/ops/comfyui-assets/sync-logs" \
            -H "Content-Type: application/json" \
            -H "X-Asset-Ops-Secret: $ASSET_OPS_SECRET" \
            -d "$payload"
