name: DB Seed

run-name: DB Seed (${{ inputs.stage }}) by @${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      stage:
        description: 'Stage to seed'
        required: true
        type: choice
        default: staging
        options:
          - staging
      aws_region:
        description: 'AWS region'
        required: true
        type: choice
        default: us-east-1
        options:
          - us-east-1
          - us-west-2
      seed_class:
        description: 'Optional seeder class (e.g. UsersSeeder or Database\\Seeders\\UsersSeeder). Leave blank to run DatabaseSeeder.'
        required: false
        type: string
        default: ''

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ inputs.aws_region }}
  STAGE: ${{ inputs.stage }}
  ECS_CLUSTER: bp-${{ inputs.stage }}
  ECS_BACKEND_TASK_DEFINITION: bp-${{ inputs.stage }}-backend

jobs:
  db-seed-staging:
    name: DB Seed (staging)
    runs-on: ubuntu-latest
    environment: staging-migrations
    if: inputs.stage == 'staging'
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.stage == 'production' && secrets.AWS_DEPLOY_ROLE_ARN_PRODUCTION || inputs.stage == 'staging' && (secrets.AWS_DEPLOY_ROLE_ARN_STAGING || secrets.AWS_DEPLOY_ROLE_ARN) }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Run db seed task (ECS one-off)
        shell: bash
        env:
          SEED_CLASS: ${{ inputs.seed_class }}
          PRIVATE_SUBNET_IDS: ${{ secrets.PRIVATE_SUBNET_IDS }}
          BACKEND_SG_ID: ${{ secrets.BACKEND_SG_ID }}
        run: |
          set -euo pipefail

          # Network config for awsvpc tasks (required for Fargate run-task).
          # Prefer environment secrets (staging-migrations), but fall back to the running ECS service config.
          SERVICE_NAME="bp-${STAGE}-backend"

          if [[ -z "${PRIVATE_SUBNET_IDS:-}" ]]; then
            PRIVATE_SUBNET_IDS=$(aws ecs describe-services \
              --cluster "${ECS_CLUSTER}" \
              --services "${SERVICE_NAME}" \
              --query 'services[0].networkConfiguration.awsvpcConfiguration.subnets' \
              --output json)
            echo "PRIVATE_SUBNET_IDS not set; derived from ECS service ${SERVICE_NAME}."
          fi

          if [[ -z "${BACKEND_SG_ID:-}" ]]; then
            BACKEND_SG_ID=$(aws ecs describe-services \
              --cluster "${ECS_CLUSTER}" \
              --services "${SERVICE_NAME}" \
              --query 'services[0].networkConfiguration.awsvpcConfiguration.securityGroups[0]' \
              --output text)
            echo "BACKEND_SG_ID not set; derived from ECS service ${SERVICE_NAME}."
          fi

          if [[ -z "${BACKEND_SG_ID:-}" || "${BACKEND_SG_ID}" == "None" ]]; then
            echo "Missing BACKEND_SG_ID. Set GitHub Environment secret staging-migrations/BACKEND_SG_ID to an sg-... value." >&2
            exit 1
          fi

          NETWORK_CONFIGURATION=$(python3 - <<'PY'
          import json, os, sys

          subnets_raw = (os.environ.get("PRIVATE_SUBNET_IDS") or "").strip()
          sg_id = (os.environ.get("BACKEND_SG_ID") or "").strip()

          if not subnets_raw:
              print('Missing PRIVATE_SUBNET_IDS. Set GitHub Environment secret staging-migrations/PRIVATE_SUBNET_IDS to JSON array like ["subnet-...","subnet-..."].', file=sys.stderr)
              sys.exit(1)

          try:
              subnets = json.loads(subnets_raw)
          except Exception:
              print('PRIVATE_SUBNET_IDS must be valid JSON array like ["subnet-...","subnet-..."].', file=sys.stderr)
              sys.exit(1)

          if not isinstance(subnets, list) or not subnets or not all(isinstance(s, str) and s for s in subnets):
              print('PRIVATE_SUBNET_IDS must be a non-empty JSON array of subnet ids.', file=sys.stderr)
              sys.exit(1)

          if not sg_id or sg_id == "None":
              print("Missing BACKEND_SG_ID (sg-...).", file=sys.stderr)
              sys.exit(1)

          print(json.dumps({
              "awsvpcConfiguration": {
                  "subnets": subnets,
                  "securityGroups": [sg_id],
              }
          }))
          PY
          )

          OVERRIDES=$(python3 - <<'PY'
          import json, os, re, sys

          seed_class = (os.environ.get("SEED_CLASS") or "").strip()
          if seed_class and not re.match(r'^[A-Za-z0-9_\\\\]+$', seed_class):
              print("seed_class must be a PHP class name (letters/numbers/_/\\\\ only).", file=sys.stderr)
              sys.exit(1)

          cmd = ["php", "artisan", "db:seed", "--force"]
          if seed_class:
              cmd.append(f"--class={seed_class}")

          print(json.dumps({
              "containerOverrides": [{
                  "name": "php-fpm",
                  "command": cmd,
              }],
          }))
          PY
          )

          TASK_ARN=$(aws ecs run-task \
            --cluster "${ECS_CLUSTER}" \
            --task-definition "${ECS_BACKEND_TASK_DEFINITION}" \
            --overrides "${OVERRIDES}" \
            --launch-type FARGATE \
            --network-configuration "${NETWORK_CONFIGURATION}" \
            --query 'tasks[0].taskArn' --output text)

          echo "Seed task: ${TASK_ARN}"
          aws ecs wait tasks-stopped --cluster "${ECS_CLUSTER}" --tasks "${TASK_ARN}"

          EXIT_CODE=$(aws ecs describe-tasks \
            --cluster "${ECS_CLUSTER}" \
            --tasks "${TASK_ARN}" \
            --query "tasks[0].containers[?name=='php-fpm'].exitCode | [0]" \
            --output text)

          STOPPED_REASON=$(aws ecs describe-tasks \
            --cluster "${ECS_CLUSTER}" \
            --tasks "${TASK_ARN}" \
            --query "tasks[0].stoppedReason" \
            --output text)

          echo "php-fpm exit code: ${EXIT_CODE}"
          echo "Stopped reason: ${STOPPED_REASON}"

          {
            echo "## DB seed"
            echo ""
            echo "- **Stage:** ${STAGE}"
            echo "- **Region:** ${AWS_REGION}"
            echo "- **Task ARN:** ${TASK_ARN}"
            echo "- **php-fpm exit code:** ${EXIT_CODE}"
          } >> "$GITHUB_STEP_SUMMARY"

          if [[ "${EXIT_CODE}" != "0" ]]; then
            echo "db:seed failed (exit code ${EXIT_CODE})." >&2
            exit 1
          fi

