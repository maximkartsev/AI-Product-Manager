name: 14 - GPU - Apply Active Bundle to Dev Instance

on:
  workflow_dispatch:
    inputs:
      instance_id:
        description: 'EC2 instance ID (dev GPU node)'
        required: true
        type: string
      fleet_slug:
        description: 'Fleet slug (e.g. gpu-default)'
        required: true
        type: string
      logs_bucket:
        description: 'Optional: S3 bucket for logs (bp-logs-<account>-<stage>)'
        required: false
        type: string
      notes:
        description: 'Optional notes for audit log'
        required: false
        type: string
      aws_region:
        description: 'AWS region'
        required: false
        default: 'us-east-1'
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  resolve-stage:
    name: Resolve Stage
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ inputs.aws_region }}
    outputs:
      stage: ${{ steps.set-stage.outputs.stage }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (staging)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN_STAGING }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check staging desired_config
        id: check-staging
        shell: bash
        run: |
          if bash .github/scripts/resolve-stage.sh --fleet-slug "${{ inputs.fleet_slug }}" --stage staging --region "${{ env.AWS_REGION }}"; then
            echo "found=true" >> "$GITHUB_OUTPUT"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Configure AWS credentials (production)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN_PRODUCTION }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check production desired_config
        id: check-production
        shell: bash
        run: |
          if bash .github/scripts/resolve-stage.sh --fleet-slug "${{ inputs.fleet_slug }}" --stage production --region "${{ env.AWS_REGION }}"; then
            echo "found=true" >> "$GITHUB_OUTPUT"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Resolve stage
        id: set-stage
        shell: bash
        run: |
          STAGING_FOUND="${{ steps.check-staging.outputs.found }}"
          PRODUCTION_FOUND="${{ steps.check-production.outputs.found }}"
          if [[ "$STAGING_FOUND" == "true" && "$PRODUCTION_FOUND" == "true" ]]; then
            echo "Fleet slug exists in both staging and production. Slugs must be globally unique." >&2
            exit 1
          fi
          if [[ "$STAGING_FOUND" == "true" ]]; then
            echo "stage=staging" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [[ "$PRODUCTION_FOUND" == "true" ]]; then
            echo "stage=production" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "No desired_config found for fleet_slug '${{ inputs.fleet_slug }}' in staging or production." >&2
          exit 1

  apply-bundle:
    name: Apply Bundle via SSM
    runs-on: ubuntu-latest
    needs: resolve-stage
    env:
      AWS_REGION: ${{ inputs.aws_region }}
      STAGE: ${{ needs.resolve-stage.outputs.stage }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.STAGE == 'production' && secrets.AWS_DEPLOY_ROLE_ARN_PRODUCTION || secrets.AWS_DEPLOY_ROLE_ARN_STAGING }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify instance is SSM-managed
        shell: bash
        run: |
          set -euo pipefail
          INSTANCE_ID="${{ inputs.instance_id }}"
          FOUND=$(aws ssm describe-instance-information \
            --filters "Key=InstanceIds,Values=${INSTANCE_ID}" \
            --query "InstanceInformationList[0].InstanceId" \
            --output text)
          if [[ -z "${FOUND}" || "${FOUND}" == "None" ]]; then
            echo "Instance ${INSTANCE_ID} is not SSM-managed. Ensure it has an SSM-enabled instance profile." >&2
            exit 1
          fi

      - name: Resolve models bucket + active bundle
        shell: bash
        run: |
          set -euo pipefail
          MODELS_BUCKET=$(aws ssm get-parameter \
            --name "/bp/${STAGE}/models/bucket" \
            --query "Parameter.Value" \
            --output text 2>/dev/null || true)
          if [[ -z "${MODELS_BUCKET}" || "${MODELS_BUCKET}" == "None" ]]; then
            echo "No models bucket found at /bp/${STAGE}/models/bucket." >&2
            exit 1
          fi

          ACTIVE_PREFIX=$(aws ssm get-parameter \
            --name "/bp/${STAGE}/fleets/${{ inputs.fleet_slug }}/active_bundle" \
            --query "Parameter.Value" \
            --output text 2>/dev/null || true)
          if [[ -z "${ACTIVE_PREFIX}" || "${ACTIVE_PREFIX}" == "None" || "${ACTIVE_PREFIX}" == "none" ]]; then
            echo "No active bundle set at /bp/${STAGE}/fleets/${{ inputs.fleet_slug }}/active_bundle." >&2
            exit 1
          fi
          ACTIVE_PREFIX="${ACTIVE_PREFIX%/}"

          echo "MODELS_BUCKET=${MODELS_BUCKET}" >> "$GITHUB_ENV"
          echo "BUNDLE_PREFIX=${ACTIVE_PREFIX}" >> "$GITHUB_ENV"

      - name: Send SSM command
        id: send
        run: |
          CMD_APPLY="MODELS_BUCKET=${MODELS_BUCKET} BUNDLE_PREFIX=${BUNDLE_PREFIX} /opt/comfyui/bin/apply-bundle.sh"
          export CMD_APPLY
          PARAMS=$(python3 - <<'PY'
          import json
          import os

          cmds = [
              'if ! test -x /opt/comfyui/bin/apply-bundle.sh; then echo "apply-bundle.sh missing (wrong AMI)"; exit 1; fi',
              os.environ["CMD_APPLY"],
              "sudo systemctl restart comfyui.service",
              "sudo systemctl restart comfyui-worker.service || true",
          ]
          print(json.dumps({"commands": cmds}))
          PY
          )
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ inputs.instance_id }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Apply ComfyUI asset bundle" \
            --parameters "${PARAMS}" \
            --timeout-seconds 21600 \
            --query "Command.CommandId" --output text)
          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
          echo "SSM command ID: $COMMAND_ID"

      - name: Wait for command completion
        shell: bash
        run: |
          # Default AWS CLI waiter is ~100 seconds which is too short for large bundles (60GB+).
          # GitHub-hosted runner max runtime is 6 hours, so we wait up to ~6 hours.
          aws ssm wait command-executed \
            --command-id "${{ steps.send.outputs.command_id }}" \
            --instance-id "${{ inputs.instance_id }}" \
            --delay 15 \
            --max-attempts 1440

      - name: Fetch command output
        if: always()
        run: |
          aws ssm get-command-invocation \
            --command-id "${{ steps.send.outputs.command_id }}" \
            --instance-id "${{ inputs.instance_id }}" \
            --output json > command-output.json
          cat command-output.json

      - name: Upload command output (optional)
        if: always() && inputs.logs_bucket != ''
        run: |
          BUNDLE_ID=$(basename "$BUNDLE_PREFIX")
          LOG_KEY="asset-sync/${{ inputs.fleet_slug }}/${BUNDLE_ID}/$(date -u +%Y%m%dT%H%M%SZ)-${{ inputs.instance_id }}.json"
          aws s3 cp command-output.json "s3://${{ inputs.logs_bucket }}/$LOG_KEY"
          echo "log_key=$LOG_KEY" >> $GITHUB_OUTPUT
        id: upload

      - name: Record audit log (optional)
        env:
          ASSET_OPS_API_URL: ${{ secrets.ASSET_OPS_API_URL }}
          ASSET_OPS_SECRET: ${{ secrets.ASSET_OPS_SECRET }}
        run: |
          if [ -z "${ASSET_OPS_API_URL}" ] || [ -z "${ASSET_OPS_SECRET}" ]; then
            echo "ASSET_OPS_* secrets not set; skipping audit log."
            exit 0
          fi

          LOG_KEY="${{ steps.upload.outputs.log_key }}"
          BUNDLE_ID=$(basename "$BUNDLE_PREFIX")
          payload=$(jq -n \
            --arg bundle_id "$BUNDLE_ID" \
            --arg event "dev_bundle_applied" \
            --arg notes "${{ inputs.notes }}" \
            --arg artifact_s3_key "$LOG_KEY" \
            --arg fleet_slug "${{ inputs.fleet_slug }}" \
            --arg instance_id "${{ inputs.instance_id }}" \
            --arg bundle_prefix "$BUNDLE_PREFIX" \
            '{bundle_id:$bundle_id,event:$event,notes:$notes,artifact_s3_key:$artifact_s3_key,metadata:{fleet_slug:$fleet_slug,instance_id:$instance_id,bundle_prefix:$bundle_prefix}}')
          curl -sS -X POST "$ASSET_OPS_API_URL/ops/comfyui-assets/sync-logs" \
            -H "Content-Type: application/json" \
            -H "X-Asset-Ops-Secret: $ASSET_OPS_SECRET" \
            -d "$payload"
