name: 01 - Deploy App (ECR + ECS)

run-name: Deploy (${{ inputs.stage }}) by @${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      stage:
        description: 'Stage to deploy'
        required: true
        type: choice
        default: staging
        options:
          - staging
          - production
      aws_region:
        description: 'AWS region'
        required: true
        type: choice
        default: us-east-1
        options:
          - us-east-1
          - us-west-2
      build_images:
        description: 'Which images to build & push to ECR'
        required: true
        type: choice
        default: all
        options:
          - all
          - backend
          - frontend
          - none
      deploy_services:
        description: 'Which ECS services to force redeploy'
        required: true
        type: choice
        default: all
        options:
          - all
          - backend
          - frontend
          - none
      run_tests:
        description: 'Which test suites to run'
        required: true
        type: choice
        default: auto
        options:
          - auto
          - all
          - backend
          - frontend
          - none

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ inputs.aws_region }}
  STAGE: ${{ inputs.stage }}
  # Resource names are constant; "stage" selects the AWS account/role.
  ECR_BACKEND_REPO: bp-backend
  ECR_FRONTEND_REPO: bp-frontend
  ECS_CLUSTER: bp
  ECS_BACKEND_SERVICE: bp-backend
  ECS_FRONTEND_SERVICE: bp-frontend
  ECS_BACKEND_TASK_DEFINITION: bp-backend

jobs:
  # ==========================================
  # Job 1: Test Backend
  # ==========================================
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mariadb:10.11
        env:
          MYSQL_ROOT_PASSWORD: testing
          MYSQL_DATABASE: bp_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mariadb-admin ping -h 127.0.0.1 -u root -ptesting"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - uses: actions/checkout@v4

      - name: Skip backend tests
        if: inputs.run_tests == 'none' || inputs.run_tests == 'frontend' || (inputs.run_tests == 'auto' && (inputs.build_images == 'frontend' || inputs.build_images == 'none'))
        run: echo "Skipping backend tests (run_tests=${{ inputs.run_tests }}, build_images=${{ inputs.build_images }})"

      - name: Setup PHP
        if: inputs.run_tests == 'all' || inputs.run_tests == 'backend' || (inputs.run_tests == 'auto' && (inputs.build_images == 'all' || inputs.build_images == 'backend'))
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: pdo_mysql, mbstring, bcmath, gd, zip, redis, pcntl
          coverage: none

      - name: Install Composer dependencies
        if: inputs.run_tests == 'all' || inputs.run_tests == 'backend' || (inputs.run_tests == 'auto' && (inputs.build_images == 'all' || inputs.build_images == 'backend'))
        working-directory: backend
        run: composer install --no-interaction --prefer-dist

      - name: Prepare environment
        if: inputs.run_tests == 'all' || inputs.run_tests == 'backend' || (inputs.run_tests == 'auto' && (inputs.build_images == 'all' || inputs.build_images == 'backend'))
        working-directory: backend
        run: |
          cp .env.example .env
          php artisan key:generate
          php artisan config:clear

      - name: Run migrations
        if: inputs.run_tests == 'all' || inputs.run_tests == 'backend' || (inputs.run_tests == 'auto' && (inputs.build_images == 'all' || inputs.build_images == 'backend'))
        working-directory: backend
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: bp_test
          DB_USERNAME: root
          DB_PASSWORD: testing
        run: php artisan migrate --force

      - name: Run tests
        if: inputs.run_tests == 'all' || inputs.run_tests == 'backend' || (inputs.run_tests == 'auto' && (inputs.build_images == 'all' || inputs.build_images == 'backend'))
        working-directory: backend
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: bp_test
          DB_USERNAME: root
          DB_PASSWORD: testing
        run: php artisan test

  # ==========================================
  # Job 2: Test Frontend
  # ==========================================
  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Skip frontend tests
        if: inputs.run_tests == 'none' || inputs.run_tests == 'backend' || (inputs.run_tests == 'auto' && (inputs.build_images == 'backend' || inputs.build_images == 'none'))
        run: echo "Skipping frontend tests (run_tests=${{ inputs.run_tests }}, build_images=${{ inputs.build_images }})"

      - name: Setup Node.js
        if: inputs.run_tests == 'all' || inputs.run_tests == 'frontend' || (inputs.run_tests == 'auto' && (inputs.build_images == 'all' || inputs.build_images == 'frontend'))
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        if: inputs.run_tests == 'all' || inputs.run_tests == 'frontend' || (inputs.run_tests == 'auto' && (inputs.build_images == 'all' || inputs.build_images == 'frontend'))
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        if: inputs.run_tests == 'all' || inputs.run_tests == 'frontend' || (inputs.run_tests == 'auto' && (inputs.build_images == 'all' || inputs.build_images == 'frontend'))
        working-directory: frontend
        run: pnpm install --frozen-lockfile

      - name: Build
        if: inputs.run_tests == 'all' || inputs.run_tests == 'frontend' || (inputs.run_tests == 'auto' && (inputs.build_images == 'all' || inputs.build_images == 'frontend'))
        working-directory: frontend
        run: pnpm build

  # ==========================================
  # Job 3: Build and Push Docker Images
  # ==========================================
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-24.04-arm
    needs: [test-backend, test-frontend]
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        if: inputs.build_images != 'none'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # Require stage-specific deploy roles.
          role-to-assume: ${{ inputs.stage == 'production' && secrets.AWS_DEPLOY_ROLE_ARN_PRODUCTION || secrets.AWS_DEPLOY_ROLE_ARN_STAGING }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        if: inputs.build_images != 'none'
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        if: inputs.build_images != 'none'
        uses: docker/setup-buildx-action@v3

      - name: Set short SHA
        if: inputs.build_images != 'none'
        run: echo "SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_ENV

      - name: Build and push backend nginx
        if: inputs.build_images == 'all' || inputs.build_images == 'backend'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: infrastructure/docker/backend/Dockerfile.nginx
          platforms: linux/arm64
          push: true
          tags: |
            ${{ steps.ecr-login.outputs.registry }}/${{ env.ECR_BACKEND_REPO }}:nginx-${{ env.SHORT_SHA }}
            ${{ steps.ecr-login.outputs.registry }}/${{ env.ECR_BACKEND_REPO }}:nginx-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push backend PHP-FPM
        if: inputs.build_images == 'all' || inputs.build_images == 'backend'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: infrastructure/docker/backend/Dockerfile.php-fpm
          platforms: linux/arm64
          push: true
          tags: |
            ${{ steps.ecr-login.outputs.registry }}/${{ env.ECR_BACKEND_REPO }}:php-${{ env.SHORT_SHA }}
            ${{ steps.ecr-login.outputs.registry }}/${{ env.ECR_BACKEND_REPO }}:php-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push frontend
        if: inputs.build_images == 'all' || inputs.build_images == 'frontend'
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: frontend/Dockerfile
          platforms: linux/arm64
          push: true
          tags: |
            ${{ steps.ecr-login.outputs.registry }}/${{ env.ECR_FRONTEND_REPO }}:${{ env.SHORT_SHA }}
            ${{ steps.ecr-login.outputs.registry }}/${{ env.ECR_FRONTEND_REPO }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==========================================
  # Job 4: Deploy ECS Services
  # ==========================================
  deploy-services:
    name: Deploy ECS Services
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: inputs.deploy_services != 'none'
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.stage == 'production' && secrets.AWS_DEPLOY_ROLE_ARN_PRODUCTION || secrets.AWS_DEPLOY_ROLE_ARN_STAGING }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy backend service
        if: inputs.deploy_services == 'all' || inputs.deploy_services == 'backend'
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_BACKEND_SERVICE }} \
            --force-new-deployment

      - name: Deploy frontend service
        if: inputs.deploy_services == 'all' || inputs.deploy_services == 'frontend'
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_FRONTEND_SERVICE }} \
            --force-new-deployment

      - name: Wait for backend stability
        if: inputs.deploy_services == 'all' || inputs.deploy_services == 'backend'
        run: |
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_BACKEND_SERVICE }}

      - name: Wait for frontend stability
        if: inputs.deploy_services == 'all' || inputs.deploy_services == 'frontend'
        run: |
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_FRONTEND_SERVICE }}
