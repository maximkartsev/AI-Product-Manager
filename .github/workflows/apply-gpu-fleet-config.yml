name: Apply GPU Fleet Config

run-name: Apply GPU Fleet Config (${{ inputs.fleet_slug }}) by @${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      fleet_slug:
        description: 'Fleet slug to update'
        required: true
        type: string
      aws_region:
        description: 'AWS region'
        required: true
        type: choice
        default: us-east-1
        options:
          - us-east-1
          - us-west-2
      confirm_apply:
        description: 'Set true to apply changes after diff'
        required: true
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

concurrency:
  group: gpu-fleet-${{ inputs.fleet_slug }}
  cancel-in-progress: false

env:
  AWS_REGION: ${{ inputs.aws_region }}
  FLEET_SLUG: ${{ inputs.fleet_slug }}

jobs:
  resolve-stage:
    name: Resolve Stage
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ inputs.aws_region }}
    outputs:
      stage: ${{ steps.set-stage.outputs.stage }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (staging)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN_STAGING }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check staging desired_config
        id: check-staging
        shell: bash
        run: |
          if bash .github/scripts/resolve-stage.sh --fleet-slug "${{ inputs.fleet_slug }}" --stage staging --region "${{ env.AWS_REGION }}"; then
            echo "found=true" >> "$GITHUB_OUTPUT"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Configure AWS credentials (production)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN_PRODUCTION }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check production desired_config
        id: check-production
        shell: bash
        run: |
          if bash .github/scripts/resolve-stage.sh --fleet-slug "${{ inputs.fleet_slug }}" --stage production --region "${{ env.AWS_REGION }}"; then
            echo "found=true" >> "$GITHUB_OUTPUT"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Resolve stage
        id: set-stage
        shell: bash
        run: |
          STAGING_FOUND="${{ steps.check-staging.outputs.found }}"
          PRODUCTION_FOUND="${{ steps.check-production.outputs.found }}"
          if [[ "$STAGING_FOUND" == "true" && "$PRODUCTION_FOUND" == "true" ]]; then
            echo "Fleet slug exists in both staging and production. Slugs must be globally unique." >&2
            exit 1
          fi
          if [[ "$STAGING_FOUND" == "true" ]]; then
            echo "stage=staging" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [[ "$PRODUCTION_FOUND" == "true" ]]; then
            echo "stage=production" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "No desired_config found for fleet_slug '${{ inputs.fleet_slug }}' in staging or production." >&2
          exit 1

  apply:
    name: Apply Fleet Config
    runs-on: ubuntu-latest
    needs: resolve-stage
    environment: ${{ needs.resolve-stage.outputs.stage == 'production' && 'production-gpu-provision' || 'staging-gpu-provision' }}
    env:
      STAGE: ${{ needs.resolve-stage.outputs.stage }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install CDK dependencies
        working-directory: infrastructure
        run: npm ci

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.STAGE == 'production' && secrets.AWS_DEPLOY_ROLE_ARN_PRODUCTION || secrets.AWS_DEPLOY_ROLE_ARN_STAGING }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Ensure fleet stack exists
        shell: bash
        run: |
          set -euo pipefail
          STACK_NAME="bp-${STAGE}-gpu-fleet-${FLEET_SLUG}"
          aws cloudformation describe-stacks --stack-name "${STACK_NAME}" --query "Stacks[0].StackStatus" --output text >/dev/null

      - name: Require explicit confirmation
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ inputs.confirm_apply }}" != "true" ]]; then
            echo "confirm_apply must be set to true to apply changes." >&2
            exit 1
          fi

      - name: Load desired fleet config
        id: desired
        shell: bash
        run: |
          set -euo pipefail
          DESIRED_JSON=$(aws ssm get-parameter \
            --name "/bp/${STAGE}/fleets/${FLEET_SLUG}/desired_config" \
            --query "Parameter.Value" \
            --output text)
          export DESIRED_JSON

          TEMPLATE_SLUG=$(python3 - <<'PY'
          import json, os, sys
          data = json.loads(os.environ["DESIRED_JSON"])
          template_slug = data.get("template_slug")
          instance_type = data.get("instance_type")
          if not template_slug or not instance_type:
            print("desired_config missing template_slug or instance_type", file=sys.stderr)
            sys.exit(1)
          print(template_slug)
          PY
          )

          INSTANCE_TYPE=$(python3 - <<'PY'
          import json, os, sys
          data = json.loads(os.environ["DESIRED_JSON"])
          instance_type = data.get("instance_type")
          if not instance_type:
            print("desired_config missing instance_type", file=sys.stderr)
            sys.exit(1)
          print(instance_type)
          PY
          )

          python3 - <<'PY'
          import json, os, sys
          desired = json.loads(os.environ["DESIRED_JSON"])
          template_slug = desired.get("template_slug")
          instance_type = desired.get("instance_type")
          with open("backend/resources/comfyui/fleet-templates.json", "r", encoding="utf-8") as handle:
              templates = json.load(handle)
          template = next((t for t in templates if t.get("template_slug") == template_slug), None)
          if not template:
              print(f"Unknown template_slug: {template_slug}", file=sys.stderr)
              sys.exit(1)
          allowed = template.get("allowed_instance_types") or []
          if instance_type not in allowed:
              print(f"Instance type {instance_type} not allowed for template {template_slug}", file=sys.stderr)
              sys.exit(1)
          PY

          echo "template_slug=$TEMPLATE_SLUG" >> "$GITHUB_OUTPUT"
          echo "instance_type=$INSTANCE_TYPE" >> "$GITHUB_OUTPUT"

      - name: Build CDK context args
        shell: bash
        run: |
          set -euo pipefail
          context_args="--context stage=${STAGE}"
          context_args="${context_args} --context fleetSlug=${FLEET_SLUG}"
          context_args="${context_args} --context templateSlug=${{ steps.desired.outputs.template_slug }}"
          context_args="${context_args} --context instanceType=${{ steps.desired.outputs.instance_type }}"
          echo "CDK_CONTEXT_ARGS=${context_args}" >> "$GITHUB_ENV"

      - name: CDK diff
        working-directory: infrastructure
        run: |
          npx cdk diff $CDK_CONTEXT_ARGS \
            bp-${STAGE}-gpu-shared \
            bp-${STAGE}-gpu-fleet-${FLEET_SLUG}

      - name: CDK deploy
        working-directory: infrastructure
        run: |
          npx cdk deploy $CDK_CONTEXT_ARGS \
            bp-${STAGE}-gpu-shared \
            bp-${STAGE}-gpu-fleet-${FLEET_SLUG} \
            --require-approval never

      - name: Summary
        run: |
          {
            echo "## GPU Fleet Updated"
            echo ""
            echo "- **Stage:** ${STAGE}"
            echo "- **Fleet:** ${FLEET_SLUG}"
            echo "- **Template:** ${{ steps.desired.outputs.template_slug }}"
            echo "- **Instance Type:** ${{ steps.desired.outputs.instance_type }}"
          } >> "$GITHUB_STEP_SUMMARY"
