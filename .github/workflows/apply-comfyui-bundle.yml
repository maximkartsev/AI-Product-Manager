name: Apply ComfyUI Bundle to Dev Instance

on:
  workflow_dispatch:
    inputs:
      instance_id:
        description: 'EC2 instance ID (dev GPU node)'
        required: true
        type: string
      fleet_slug:
        description: 'Fleet slug (e.g. gpu-default)'
        required: true
        type: string
      bundle_prefix:
        description: 'Bundle S3 prefix (e.g. bundles/<owner_slug>/<bundle_id>)'
        required: true
        type: string
      models_bucket:
        description: 'S3 bucket with asset bundles (bp-models-<account>-<stage>)'
        required: true
        type: string
      logs_bucket:
        description: 'Optional: S3 bucket for logs (bp-logs-<account>-<stage>)'
        required: false
        type: string
      notes:
        description: 'Optional notes for audit log'
        required: false
        type: string
      aws_region:
        description: 'AWS region'
        required: false
        default: 'us-east-1'
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  apply-bundle:
    name: Apply Bundle via SSM
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ inputs.aws_region }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Send SSM command
        id: send
        run: |
          BUNDLE_PREFIX="${{ inputs.bundle_prefix }}"
          BUNDLE_PREFIX="${BUNDLE_PREFIX%/}"
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ inputs.instance_id }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Apply ComfyUI asset bundle" \
            --parameters commands="MODELS_BUCKET=${{ inputs.models_bucket }} BUNDLE_PREFIX=$BUNDLE_PREFIX /opt/comfyui/bin/apply-bundle.sh && sudo systemctl restart comfyui.service && (sudo systemctl restart comfyui-worker.service || true)" \
            --query "Command.CommandId" --output text)
          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
          echo "SSM command ID: $COMMAND_ID"

      - name: Wait for command completion
        run: |
          aws ssm wait command-executed \
            --command-id "${{ steps.send.outputs.command_id }}" \
            --instance-id "${{ inputs.instance_id }}"

      - name: Fetch command output
        run: |
          aws ssm get-command-invocation \
            --command-id "${{ steps.send.outputs.command_id }}" \
            --instance-id "${{ inputs.instance_id }}" \
            --output json > command-output.json
          cat command-output.json

      - name: Upload command output (optional)
        if: inputs.logs_bucket != ''
        run: |
          BUNDLE_PREFIX="${{ inputs.bundle_prefix }}"
          BUNDLE_PREFIX="${BUNDLE_PREFIX%/}"
          BUNDLE_ID=$(basename "$BUNDLE_PREFIX")
          LOG_KEY="asset-sync/${{ inputs.fleet_slug }}/${BUNDLE_ID}/$(date -u +%Y%m%dT%H%M%SZ)-${{ inputs.instance_id }}.json"
          aws s3 cp command-output.json "s3://${{ inputs.logs_bucket }}/$LOG_KEY"
          echo "log_key=$LOG_KEY" >> $GITHUB_OUTPUT
        id: upload

      - name: Record audit log (optional)
        env:
          ASSET_OPS_API_URL: ${{ secrets.ASSET_OPS_API_URL }}
          ASSET_OPS_SECRET: ${{ secrets.ASSET_OPS_SECRET }}
        run: |
          if [ -z "${ASSET_OPS_API_URL}" ] || [ -z "${ASSET_OPS_SECRET}" ]; then
            echo "ASSET_OPS_* secrets not set; skipping audit log."
            exit 0
          fi

          LOG_KEY="${{ steps.upload.outputs.log_key }}"
          BUNDLE_PREFIX="${{ inputs.bundle_prefix }}"
          BUNDLE_PREFIX="${BUNDLE_PREFIX%/}"
          BUNDLE_ID=$(basename "$BUNDLE_PREFIX")
          payload=$(jq -n \
            --arg bundle_id "$BUNDLE_ID" \
            --arg event "dev_bundle_applied" \
            --arg notes "${{ inputs.notes }}" \
            --arg artifact_s3_key "$LOG_KEY" \
            --arg fleet_slug "${{ inputs.fleet_slug }}" \
            --arg instance_id "${{ inputs.instance_id }}" \
            --arg bundle_prefix "$BUNDLE_PREFIX" \
            '{bundle_id:$bundle_id,event:$event,notes:$notes,artifact_s3_key:$artifact_s3_key,metadata:{fleet_slug:$fleet_slug,instance_id:$instance_id,bundle_prefix:$bundle_prefix}}')
          curl -sS -X POST "$ASSET_OPS_API_URL/ops/comfyui-assets/sync-logs" \
            -H "Content-Type: application/json" \
            -H "X-Asset-Ops-Secret: $ASSET_OPS_SECRET" \
            -d "$payload"
