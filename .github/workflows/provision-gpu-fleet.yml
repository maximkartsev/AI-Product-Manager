name: Provision GPU Fleet

run-name: Provision GPU Fleet (${{ inputs.stage }} / ${{ inputs.fleet_slug }}) by @${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      stage:
        description: 'Stage to provision'
        required: true
        type: choice
        default: staging
        options:
          - staging
          - production
      fleet_slug:
        description: 'Fleet slug (must exist in desired_config)'
        required: true
        type: string
      aws_region:
        description: 'AWS region'
        required: true
        type: choice
        default: us-east-1
        options:
          - us-east-1
          - us-west-2

permissions:
  id-token: write
  contents: read

concurrency:
  group: gpu-fleet-${{ inputs.stage }}-${{ inputs.fleet_slug }}
  cancel-in-progress: false

env:
  AWS_REGION: ${{ inputs.aws_region }}
  STAGE: ${{ inputs.stage }}
  FLEET_SLUG: ${{ inputs.fleet_slug }}

jobs:
  provision:
    name: Provision Fleet
    runs-on: ubuntu-latest
    environment: ${{ inputs.stage == 'production' && 'production-gpu-provision' || 'staging-gpu-provision' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install CDK dependencies
        working-directory: infrastructure
        run: npm ci

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.stage == 'production' && secrets.AWS_DEPLOY_ROLE_ARN_PRODUCTION || inputs.stage == 'staging' && (secrets.AWS_DEPLOY_ROLE_ARN_STAGING || secrets.AWS_DEPLOY_ROLE_ARN) }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify base stacks exist
        shell: bash
        run: |
          set -euo pipefail
          prefix="bp-${STAGE}"
          for stack in "${prefix}-network" "${prefix}-data" "${prefix}-compute"; do
            aws cloudformation describe-stacks --stack-name "$stack" --query "Stacks[0].StackStatus" --output text >/dev/null
          done

      - name: Load desired fleet config
        id: desired
        shell: bash
        run: |
          set -euo pipefail
          DESIRED_JSON=$(aws ssm get-parameter \
            --name "/bp/${STAGE}/fleets/${FLEET_SLUG}/desired_config" \
            --query "Parameter.Value" \
            --output text)
          export DESIRED_JSON

          TEMPLATE_SLUG=$(python3 - <<'PY'
          import json, os, sys
          data = json.loads(os.environ["DESIRED_JSON"])
          template_slug = data.get("template_slug")
          instance_type = data.get("instance_type")
          if not template_slug or not instance_type:
            print("desired_config missing template_slug or instance_type", file=sys.stderr)
            sys.exit(1)
          print(template_slug)
          PY
          )

          INSTANCE_TYPE=$(python3 - <<'PY'
          import json, os, sys
          data = json.loads(os.environ["DESIRED_JSON"])
          instance_type = data.get("instance_type")
          if not instance_type:
            print("desired_config missing instance_type", file=sys.stderr)
            sys.exit(1)
          print(instance_type)
          PY
          )

          python3 - <<'PY'
          import json, os, sys
          desired = json.loads(os.environ["DESIRED_JSON"])
          template_slug = desired.get("template_slug")
          instance_type = desired.get("instance_type")
          with open("backend/resources/comfyui/fleet-templates.json", "r", encoding="utf-8") as handle:
              templates = json.load(handle)
          template = next((t for t in templates if t.get("template_slug") == template_slug), None)
          if not template:
              print(f"Unknown template_slug: {template_slug}", file=sys.stderr)
              sys.exit(1)
          allowed = template.get("allowed_instance_types") or []
          if instance_type not in allowed:
              print(f"Instance type {instance_type} not allowed for template {template_slug}", file=sys.stderr)
              sys.exit(1)
          PY

          echo "template_slug=$TEMPLATE_SLUG" >> "$GITHUB_OUTPUT"
          echo "instance_type=$INSTANCE_TYPE" >> "$GITHUB_OUTPUT"

      - name: Ensure AMI parameter exists
        shell: bash
        run: |
          set -euo pipefail
          aws ssm get-parameter \
            --name "/bp/ami/fleets/${STAGE}/${FLEET_SLUG}" \
            --query "Parameter.Value" \
            --output text >/dev/null

      - name: Ensure fleet stack does not already exist
        shell: bash
        run: |
          set -euo pipefail
          STACK_NAME="bp-${STAGE}-gpu-fleet-${FLEET_SLUG}"
          if aws cloudformation describe-stacks --stack-name "${STACK_NAME}" --query "Stacks[0].StackStatus" --output text >/dev/null 2>&1; then
            echo "Fleet stack ${STACK_NAME} already exists. Use apply-gpu-fleet-config.yml to update it." >&2
            exit 1
          fi

      - name: Build CDK context args
        shell: bash
        run: |
          set -euo pipefail
          context_args="--context stage=${STAGE}"
          context_args="${context_args} --context fleetSlug=${FLEET_SLUG}"
          context_args="${context_args} --context templateSlug=${{ steps.desired.outputs.template_slug }}"
          context_args="${context_args} --context instanceType=${{ steps.desired.outputs.instance_type }}"
          echo "CDK_CONTEXT_ARGS=${context_args}" >> "$GITHUB_ENV"

      - name: CDK diff
        working-directory: infrastructure
        run: |
          npx cdk diff $CDK_CONTEXT_ARGS \
            bp-${STAGE}-gpu-shared \
            bp-${STAGE}-gpu-fleet-${FLEET_SLUG}

      - name: CDK deploy
        working-directory: infrastructure
        run: |
          npx cdk deploy $CDK_CONTEXT_ARGS \
            bp-${STAGE}-gpu-shared \
            bp-${STAGE}-gpu-fleet-${FLEET_SLUG} \
            --require-approval never

      - name: Summary
        run: |
          {
            echo "## GPU Fleet Provisioned"
            echo ""
            echo "- **Stage:** ${STAGE}"
            echo "- **Fleet:** ${FLEET_SLUG}"
            echo "- **Template:** ${{ steps.desired.outputs.template_slug }}"
            echo "- **Instance Type:** ${{ steps.desired.outputs.instance_type }}"
            echo "- **AMI Param:** /bp/ami/fleets/${STAGE}/${FLEET_SLUG}"
            echo "- **Active Bundle Param:** /bp/${STAGE}/fleets/${FLEET_SLUG}/active_bundle"
            echo "- **ASG Name:** asg-${STAGE}-${FLEET_SLUG}"
          } >> "$GITHUB_STEP_SUMMARY"
