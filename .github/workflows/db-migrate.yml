---
name: DB Migrate

run-name: DB Migrate (${{ inputs.stage }}) by @${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      stage:
        description: 'Stage to migrate'
        required: true
        type: choice
        default: staging
        options:
          - staging
          - production
      aws_region:
        description: 'AWS region'
        required: true
        type: choice
        default: us-east-1
        options:
          - us-east-1
          - us-west-2
      pools:
        description: 'Optional: comma-separated tenant pool connection names (e.g. tenant_pool_1,tenant_pool_2). Leave blank for all configured pools.'
        required: false
        type: string
        default: ''

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ inputs.aws_region }}
  STAGE: ${{ inputs.stage }}
  ECS_CLUSTER: bp-${{ inputs.stage }}
  ECS_BACKEND_TASK_DEFINITION: bp-${{ inputs.stage }}-backend

jobs:
  db-migrate:
    name: DB Migrate (${{ inputs.stage }})
    runs-on: ubuntu-latest
    environment: ${{ inputs.stage == 'production' && 'production-migrations' || 'staging-migrations' }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.stage == 'production' && secrets.AWS_DEPLOY_ROLE_ARN_PRODUCTION || inputs.stage == 'staging' && (secrets.AWS_DEPLOY_ROLE_ARN_STAGING || secrets.AWS_DEPLOY_ROLE_ARN) }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Run migrations task (ECS one-off)
        shell: bash
        env:
          POOLS: ${{ inputs.pools }}
          PRIVATE_SUBNET_IDS: ${{ secrets.PRIVATE_SUBNET_IDS }}
          BACKEND_SG_ID: ${{ secrets.BACKEND_SG_ID }}
        run: |
          set -euo pipefail

          ENV_NAME="staging-migrations"
          if [[ "${STAGE}" == "production" ]]; then
            ENV_NAME="production-migrations"
          fi
          export ENV_NAME

          # Network config for awsvpc tasks (required for Fargate run-task).
          # Prefer environment secrets, but fall back to the running ECS service config.
          SERVICE_NAME="bp-${STAGE}-backend"

          if [[ -z "${PRIVATE_SUBNET_IDS:-}" ]]; then
            PRIVATE_SUBNET_IDS=$(aws ecs describe-services \
              --cluster "${ECS_CLUSTER}" \
              --services "${SERVICE_NAME}" \
              --query 'services[0].networkConfiguration.awsvpcConfiguration.subnets' \
              --output json)
            echo "PRIVATE_SUBNET_IDS not set; derived from ECS service ${SERVICE_NAME}."
          fi

          if [[ -z "${BACKEND_SG_ID:-}" ]]; then
            BACKEND_SG_ID=$(aws ecs describe-services \
              --cluster "${ECS_CLUSTER}" \
              --services "${SERVICE_NAME}" \
              --query 'services[0].networkConfiguration.awsvpcConfiguration.securityGroups[0]' \
              --output text)
            echo "BACKEND_SG_ID not set; derived from ECS service ${SERVICE_NAME}."
          fi

          if [[ -z "${BACKEND_SG_ID:-}" || "${BACKEND_SG_ID}" == "None" ]]; then
            echo "Missing BACKEND_SG_ID. Set GitHub Environment secret ${ENV_NAME}/BACKEND_SG_ID to an sg-... value." >&2
            exit 1
          fi

          NETWORK_CONFIGURATION=$(python3 - <<'PY'
          import json, os, sys

          subnets_raw = (os.environ.get("PRIVATE_SUBNET_IDS") or "").strip()
          sg_id = (os.environ.get("BACKEND_SG_ID") or "").strip()
          env_name = (os.environ.get("ENV_NAME") or "staging-migrations").strip()

          if not subnets_raw:
              print(f'Missing PRIVATE_SUBNET_IDS. Set GitHub Environment secret {env_name}/PRIVATE_SUBNET_IDS to JSON array like ["subnet-...","subnet-..."].', file=sys.stderr)
              sys.exit(1)

          try:
              subnets = json.loads(subnets_raw)
          except Exception:
              print('PRIVATE_SUBNET_IDS must be valid JSON array like ["subnet-...","subnet-..."].', file=sys.stderr)
              sys.exit(1)

          if not isinstance(subnets, list) or not subnets or not all(isinstance(s, str) and s for s in subnets):
              print('PRIVATE_SUBNET_IDS must be a non-empty JSON array of subnet ids.', file=sys.stderr)
              sys.exit(1)

          if not sg_id or sg_id == "None":
              print(f"Missing BACKEND_SG_ID (sg-...). Set GitHub Environment secret {env_name}/BACKEND_SG_ID.", file=sys.stderr)
              sys.exit(1)

          print(json.dumps({
              "awsvpcConfiguration": {
                  "subnets": subnets,
                  "securityGroups": [sg_id],
              }
          }))
          PY
          )

          OVERRIDES=$(python3 - <<'PY'
          import json, os, re, sys

          pools = (os.environ.get("POOLS") or "").strip()
          if pools and not re.match(r'^[A-Za-z0-9_,\\-]+$', pools):
              print("pools must be a comma-separated list of connection names (letters/numbers/_/-/comma only).", file=sys.stderr)
              sys.exit(1)

          cmd = ["php", "artisan", "tenancy:pools-migrate", "-vvv"]
          if pools:
              cmd.append(f"--pools={pools}")

          print(json.dumps({
              "containerOverrides": [{
                  "name": "php-fpm",
                  "command": cmd,
              }],
          }))
          PY
          )

          TASK_ARN=$(aws ecs run-task \
            --cluster "${ECS_CLUSTER}" \
            --task-definition "${ECS_BACKEND_TASK_DEFINITION}" \
            --overrides "${OVERRIDES}" \
            --launch-type FARGATE \
            --network-configuration "${NETWORK_CONFIGURATION}" \
            --query 'tasks[0].taskArn' --output text)

          echo "Migration task: ${TASK_ARN}"
          aws ecs wait tasks-stopped --cluster "${ECS_CLUSTER}" --tasks "${TASK_ARN}"

          EXIT_CODE=$(aws ecs describe-tasks \
            --cluster "${ECS_CLUSTER}" \
            --tasks "${TASK_ARN}" \
            --query "tasks[0].containers[?name=='php-fpm'].exitCode | [0]" \
            --output text)

          STOPPED_REASON=$(aws ecs describe-tasks \
            --cluster "${ECS_CLUSTER}" \
            --tasks "${TASK_ARN}" \
            --query "tasks[0].stoppedReason" \
            --output text)

          echo "php-fpm exit code: ${EXIT_CODE}"
          echo "Stopped reason: ${STOPPED_REASON}"

          # Best-effort: print CloudWatch logs for the task's php-fpm container
          TASK_ID="${TASK_ARN##*/}"
          LOG_GROUP="/ecs/bp-backend-${STAGE}"
          LOG_STREAM_PREFIX="php/php-fpm/${TASK_ID}"

          echo "CloudWatch log group: ${LOG_GROUP}"
          echo "CloudWatch log stream prefix: ${LOG_STREAM_PREFIX}"

          set +e
          LOG_STREAM_NAME=$(aws logs describe-log-streams \
            --log-group-name "${LOG_GROUP}" \
            --log-stream-name-prefix "${LOG_STREAM_PREFIX}" \
            --query 'logStreams[0].logStreamName' \
            --output text 2>/dev/null)

          if [[ -z "${LOG_STREAM_NAME}" || "${LOG_STREAM_NAME}" == "None" ]]; then
            LOG_STREAM_NAME="${LOG_STREAM_PREFIX}"
          fi

          echo "---- php-fpm logs (tail) ----"
          aws logs get-log-events \
            --log-group-name "${LOG_GROUP}" \
            --log-stream-name "${LOG_STREAM_NAME}" \
            --limit 200 \
            --no-start-from-head \
            --query 'events[].message' \
            --output text
          echo "---- end php-fpm logs ----"
          set -e

          {
            echo "## DB migrations"
            echo ""
            echo "- **Stage:** ${STAGE}"
            echo "- **Region:** ${AWS_REGION}"
            echo "- **Task ARN:** ${TASK_ARN}"
            echo "- **php-fpm exit code:** ${EXIT_CODE}"
          } >> "$GITHUB_STEP_SUMMARY"

          if [[ "${EXIT_CODE}" != "0" ]]; then
            echo "tenancy:pools-migrate failed (exit code ${EXIT_CODE})." >&2
            exit 1
          fi
